<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - Student Registration</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .card { background:#fff; padding:32px 28px 28px; border-radius:10px; width:320px; box-shadow:0 4px 16px rgba(0,0,0,0.12); }
    h2 { margin-top:0; text-align:center; font-size:20px; }
    label { font-weight:bold; display:block; margin-top:16px; }
    input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    button { width:100%; margin-top:22px; padding:10px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:15px; }
    button:hover { background:#0056b3; }
    .msg { margin-top:16px; padding:10px; border-radius:6px; font-size:14px; text-align:center; display:none; }
    .error { background:#f8d7da; color:#721c24; }
    .success { background:#d4edda; color:#155724; }
    .hint { font-size:12px; color:#555; margin-top:8px; text-align:center; }
    a.small { display:block; text-align:center; margin-top:14px; font-size:13px; color:#007bff; text-decoration:none; }
    a.small:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Login</h2>
    <form id="loginForm">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required placeholder="Enter username" autocomplete="username">
      <label for="password" style="margin-top:12px;">Password</label>
      <input type="password" id="password" name="password" required placeholder="Enter password" autocomplete="current-password">
      <div class="hint" style="color:#007bff;font-weight:bold;margin-top:8px;">Default: admin / admin</div>
      <button type="submit" id="loginBtn">Login</button>
      <button type="button" id="logoutBtn" style="display:none;margin-top:10px;background:#dc3545;">Logout</button>
    </form>
    <div id="msg" class="msg"></div>
    <div class="hint">Enter your username and password to access the system.</div>
    <div id="error" style="color:red;"></div>
  </div>
  <script src="/static/auth.js"></script>
  <script>
    // Show logout button if already logged in
    if (localStorage.getItem('security_token')) {
      document.getElementById('logoutBtn').style.display = 'block';
    }
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('security_token');
      window.location.reload();
    };
    document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        document.getElementById('error').innerText = '';
        const btn = document.getElementById('loginBtn');
        btn.disabled = true;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const res = await fetch('/custom-login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            if (res.ok) {
                const data = await res.json();
                if (data.token) {
                    localStorage.setItem('security_token', data.token);
                    // Force reload to ensure token is checked
                    window.location.replace('/');
                } else {
                    document.getElementById('error').innerText = 'Login failed: No token received.';
                }
            } else {
                const err = await res.json();
                document.getElementById('error').innerText = err.error || 'Invalid credentials';
            }
        } catch (e) {
            document.getElementById('error').innerText = 'Network error. Please try again.';
        }
        btn.disabled = false;
    };
  </script>
</body>
</html>
